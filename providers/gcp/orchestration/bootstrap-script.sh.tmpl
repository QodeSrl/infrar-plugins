#!/bin/bash
# GCP Bootstrap Script
# Auto-generated by Infrar from template
# Project: {{ .ProjectName }}
# Provider: {{ .Provider }}

set -e  # Exit on error

echo "=========================================="
echo "GCP Bootstrap for {{ .ProjectName }}"
echo "=========================================="
echo ""

# Configuration
PROJECT_ID="{{ .Metadata.project_id }}"
REGION="{{ .Variables.region | default "us-central1" }}"

echo "Project ID: $PROJECT_ID"
echo "Region: $REGION"
echo ""

# Enable required APIs
echo "Enabling required GCP APIs..."
echo ""

# Bootstrap API (required for terraform to work)
echo "→ Enabling Cloud Resource Manager API..."
gcloud services enable cloudresourcemanager.googleapis.com \
  --project=$PROJECT_ID \
  2>&1 || echo "  (Already enabled or permission denied)"

{{- if .Capabilities }}
{{- range .Capabilities }}
{{- if eq .Type "storage" }}

# Storage APIs
echo "→ Enabling Cloud Storage API..."
gcloud services enable storage.googleapis.com \
  --project=$PROJECT_ID \
  2>&1 || echo "  (Already enabled or permission denied)"
{{- end }}
{{- if eq .Type "compute" }}

# Compute APIs
echo "→ Enabling Cloud Run API..."
gcloud services enable run.googleapis.com \
  --project=$PROJECT_ID \
  2>&1 || echo "  (Already enabled or permission denied)"

echo "→ Enabling Cloud Functions API..."
gcloud services enable cloudfunctions.googleapis.com \
  --project=$PROJECT_ID \
  2>&1 || echo "  (Already enabled or permission denied)"

echo "→ Enabling Cloud Build API..."
gcloud services enable cloudbuild.googleapis.com \
  --project=$PROJECT_ID \
  2>&1 || echo "  (Already enabled or permission denied)"
{{- end }}
{{- if eq .Type "database" }}

# Database APIs
echo "→ Enabling Cloud SQL Admin API..."
gcloud services enable sqladmin.googleapis.com \
  --project=$PROJECT_ID \
  2>&1 || echo "  (Already enabled or permission denied)"
{{- end }}
{{- end }}
{{- end }}

# Wait for APIs to propagate
echo ""
echo "Waiting for APIs to fully activate..."
sleep 10

echo ""
echo "=========================================="
echo "✓ Bootstrap Complete!"
echo "=========================================="
echo ""
echo "Next steps:"
echo "  1. Run: terraform init"
echo "  2. Run: terraform plan"
echo "  3. Run: terraform apply"
echo ""
